<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ×–×× ×™× - ×’× ×™×</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .app {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        .sync-status {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 8px;
        }
        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .date-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 85px;
            z-index: 99;
        }
        .date-nav button {
            background: #667eea;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
        }
        .date-nav button:hover {
            background: #5568d3;
            transform: scale(1.1);
        }
        .date-nav button:active {
            transform: scale(0.95);
        }
        .current-date {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            text-align: center;
            flex: 1;
        }
        .today-btn {
            background: #4caf50 !important;
            width: auto !important;
            padding: 0 15px !important;
            border-radius: 20px !important;
            font-size: 0.9em !important;
        }
        .tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 145px;
            z-index: 98;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: white;
            border: none;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
        }
        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        .content {
            padding: 20px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .lesson-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }
        .lesson-card.done {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        .lesson-card.cancelled {
            background: #ffebee;
            border-color: #f44336;
            opacity: 0.6;
        }
        .lesson-card.double {
            border-left: 5px solid #ff9800;
        }
        .lesson-card.makeup {
            border-left: 5px solid #9c27b0;
            background: #f3e5f5;
        }
        .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .lesson-time {
            font-size: 0.9em;
            color: #667eea;
            font-weight: 600;
        }
        .lesson-name {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .lesson-details {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }
        .lesson-actions {
            display: flex;
            gap: 8px;
        }
        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-done {
            background: #4caf50;
            color: white;
        }
        .btn-done.active {
            background: #2e7d32;
        }
        .btn-double {
            background: #ff9800;
            color: white;
        }
        .btn-double.active {
            background: #e65100;
        }
        .btn-cancel {
            background: #f44336;
            color: white;
        }
        .btn-cancel.active {
            background: #c62828;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-card.ramla {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        }
        .stat-card.by {
            background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%);
        }
        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }
        .stat-subvalue {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 5px;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .report-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            font-size: 0.9em;
            text-align: right;
        }
        .report-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }
        .report-table tr:last-child td {
            border-bottom: none;
        }
        .total-row {
            background: #f5f5f5;
            font-weight: bold;
        }
        .export-btn {
            width: 100%;
            padding: 15px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 10px;
        }
        .add-makeup-btn {
            width: 100%;
            padding: 15px;
            background: #9c27b0;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin: 30px 0 15px 0;
        }
        .daily-km-summary {
            margin-top: 20px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            border: 1px solid #d0e0ff;
        }
        @media (max-width: 600px) {
            .app { box-shadow: none; }
            .header h1 { font-size: 1.5em; }
            .stat-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>ğŸ“š ×œ×•×— ×–×× ×™× - ×’× ×™×</h1>
            <div class="sync-status">
                <span class="sync-indicator"></span>
                × ×ª×•× ×™× × ×©××¨×™× ××•×˜×•××˜×™×ª ×‘×¢× ×Ÿ
            </div>
        </div>

        <div class="date-nav">
            <button onclick="changeDate(-1)" title="×™×•× ×§×•×“×">â—€</button>
            <div class="current-date" id="currentDate"></div>
            <button class="today-btn" onclick="goToToday()">×”×™×•×</button>
            <button onclick="changeDate(1)" title="×™×•× ×”×‘×">â–¶</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('daily')">×™×•××™</button>
            <button class="tab" onclick="showTab('makeup')">×”×©×œ××•×ª</button>
            <button class="tab" onclick="showTab('weekly')">×©×‘×•×¢×™</button>
            <button class="tab" onclick="showTab('monthly')">×—×•×“×©×™</button>
        </div>

        <div class="content">
            <div id="daily" class="tab-content active">
                <div id="dailyLessons"></div>
                <div id="dailyKmSummary" class="daily-km-summary"></div>
            </div>

            <div id="makeup" class="tab-content">
                <button class="add-makeup-btn" onclick="showAddMakeup()">â• ×”×•×¡×£ ×©×™×¢×•×¨ ×”×©×œ××”</button>
                <div id="makeupLessons"></div>
            </div>

            <div id="weekly" class="tab-content">
                <button class="export-btn" onclick="exportReport('weekly')">ğŸ“¥ ×™×™×¦×•× ×“×•×— ×©×‘×•×¢×™</button>
                <div id="weeklyContent"></div>
            </div>

            <div id="monthly" class="tab-content">
                <button class="export-btn" onclick="exportReport('monthly')">ğŸ“¥ ×™×™×¦×•× ×“×•×— ×—×•×“×©×™</button>
                <div id="monthlyContent"></div>
            </div>
        </div>
    </div>

    <!-- Firebase Compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCv7GIt_uLo6kTNTc3yCW5UDH8je0n-E18",
            authDomain: "kindergarten-schedule-yo-80f08.firebaseapp.com",
            databaseURL: "https://kindergarten-schedule-yo-80f08-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "kindergarten-schedule-yo-80f08",
            storageBucket: "kindergarten-schedule-yo-80f08.firebasestorage.app",
            messagingSenderId: "960207808761",
            appId: "1:960207808761:web:4283824abee35eaeecda28"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        window.db = db;
        console.log("Firebase ××—×•×‘×¨!");
    </script>

    <script>
        const SCHEDULE = [
            { name: '× ×•×•×” ××§×¡×™×', address: '×”×•×¨×“×™× 19, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 0, time: '08:30' },
            { name: '××‘×™×‘', address: '×“×•×“ ×¨×–×™××œ 32, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 0, time: '09:25' },
            { name: '×”×‘×™×ª ×©×œ ×™×¢×œ', address: '××¨×“×›×™ ×’×•×¨ 4, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 0, time: '10:20' },
            { name: '×”×¢×¥ ×”× ×“×™×‘', address: '××¨×“×›×™ ×’×•×¨ 4, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 0, time: '11:15' },
            { name: '×“×œ×ª ×”×§×¡××™×', address: '××¨×“×›×™ ×’×•×¨ 9, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 0, time: '12:10' },
            { name: '×”×ª×× ×”', address: '××¨×™×” ×§×¨××¨ 20, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 0, time: '13:00' },
            { name: '×›× ×¨×ª', address: '×¦×”×œ 1, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 1, time: '08:45' },
            { name: '×“×™×¨×” ×œ×”×©×›×™×¨', address: '××¨×“×›×™ ×’×•×¨ 4, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 1, time: '09:40' },
            { name: '××™×™××•×Ÿ', address: '×‘×¨ ××™×œ×Ÿ 24, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 1, time: '10:35' },
            { name: '×™×§×™× ×˜×•×Ÿ ×¨', address: '×•×™×œ× × 8, ×¨××œ×”', city: '×¨××œ×”', type: '×¡×¤×•×¨×˜×™×’×Ÿ', day: 1, time: '11:25' },
            { name: '×—×¦×‘', address: '×œ×©× 1, ×‘××¨ ×™×¢×§×‘', city: '×‘××¨ ×™×¢×§×‘', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 2, time: '08:30' },
            { name: '×ª×œ×ª×Ÿ', address: '×‘×¨×§×ª 10, ×‘××¨ ×™×¢×§×‘', city: '×‘××¨ ×™×¢×§×‘', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 2, time: '09:25' },
            { name: '×—×¨××•×Ÿ', address: '×©×”× 17, ×‘××¨ ×™×¢×§×‘', city: '×‘××¨ ×™×¢×§×‘', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 2, time: '10:20' },
            { name: '×¨×‘×§×”', address: '×©×”× 21, ×‘××¨ ×™×¢×§×‘', city: '×‘××¨ ×™×¢×§×‘', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 2, time: '11:10' },
            { name: '×™×§×™× ×˜×•×Ÿ ×‘', address: '×”×“×§×œ 2, ×‘××¨ ×™×¢×§×‘', city: '×‘××¨ ×™×¢×§×‘', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 2, time: '12:10' },
            { name: '×’×œ×‘×•×¢', address: '×”×–×™×ª 5, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 3, time: '08:30' },
            { name: '××¤×•×—×™×ª', address: '×™×•×¡×™ ×‘× ××™ 22, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 3, time: '09:30' },
            { name: '×¡× ×•× ×™×ª', address: '×©×”× 15, ×‘××¨ ×™×¢×§×‘', city: '×‘××¨ ×™×¢×§×‘', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 3, time: '10:30' },
            { name: '× ×•×¤×¨', address: '×‘×¨×•×© 1, ×‘××¨ ×™×¢×§×‘', city: '×‘××¨ ×™×¢×§×‘', type: '×¡×¤×•×¨×˜×™×’×Ÿ', day: 3, time: '11:25' },
            { name: '×“×¤× ×”', address: '×‘×¨×•×© 1, ×‘××¨ ×™×¢×§×‘', city: '×‘××¨ ×™×¢×§×‘', type: '×¡×¤×•×¨×˜×™×’×Ÿ', day: 3, time: '12:15' },
            { name: '×™× ×©×•×£', address: '×©×”× 15, ×‘××¨ ×™×¢×§×‘', city: '×‘××¨ ×™×¢×§×‘', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 4, time: '09:00' },
            { name: '× ×’×”', address: '×©×‘×™×˜ 7, ×‘××¨ ×™×¢×§×‘', city: '×‘××¨ ×™×¢×§×‘', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 4, time: '09:55' },
            { name: '×›×•×‘×¢ ×”×§×¡××™×', address: '×¨×¤××œ ××™×ª×Ÿ 2, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 4, time: '11:00' },
            { name: '×”××©×œ', address: '××¨×™×” ×§×¨××¨ 20, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 4, time: '11:50' },
            { name: '×¨××‘"×', address: '×’×™×‘×•×¨×™ ×™×©×¨××œ 1, ×¨××œ×”', city: '×¨××œ×”', type: '×¤×œ××™ ×ª××˜×¨×•×Ÿ', day: 4, time: '12:45' }
        ];

        const DAY_NAMES = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];

        let currentDate = new Date();
        let completedLessons = {};
        let makeupLessons = {};
        let currentLocation = { lat: 31.9730, lng: 34.7925 }; // ×¨××œ×” ×›×‘×¨×™×¨×ª ××—×“×œ

        // ×§×‘×œ ××™×§×•× × ×•×›×—×™
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                console.log("××™×§×•× × ×•×›×—×™:", currentLocation);
                renderAll();
            }, err => {
                console.log("×œ× × ×™×ª×Ÿ ×œ×§×‘×œ ××™×§×•×:", err.message);
            });
        }

        // ×˜×¢×™× ×ª × ×ª×•× ×™× ×-Firebase ×‘×–××Ÿ ×××ª
        function loadData() {
            db.ref('completedLessons').on('value', (snapshot) => {
                completedLessons = snapshot.val() || {};
                renderAll();
            });

            db.ref('makeupLessons').on('value', (snapshot) => {
                makeupLessons = snapshot.val() || {};
                renderAll();
            });
        }

        function getLessonKey(date, lessonName) {
            return `${date.toISOString().split('T')[0]}-${lessonName}`;
        }

        function getLessonStatus(date, lessonName) {
            const key = getLessonKey(date, lessonName);
            return completedLessons[key] || 'pending';
        }

        function setLessonStatus(date, lessonName, status) {
            const dateStr = date.toISOString().split('T')[0];
            const key = `${dateStr}-${lessonName}`;
            const ref = db.ref(`completedLessons/${key}`);

            if (status === 'pending') {
                ref.remove();
            } else {
                ref.set(status);
            }
        }

        function updateDateDisplay() {
            const dayName = DAY_NAMES[currentDate.getDay()];
            const dateStr = currentDate.toLocaleDateString('he-IL', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            document.getElementById('currentDate').textContent = `${dayName}, ${dateStr}`;
        }

        function changeDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            updateDateDisplay();
            renderAll();
        }

        function goToToday() {
            currentDate = new Date();
            updateDateDisplay();
            renderAll();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            renderAll();
        }

        // ×”××¨×ª ×›×ª×•×‘×ª ×œ-lat/lng ×¢× Nominatim (×—×™× ××™)
        async function geocodeAddress(address) {
            try {
                const encoded = encodeURIComponent(address + ", Israel");
                const url = `https://nominatim.openstreetmap.org/search?q=${encoded}&format=json&limit=1`;
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'KindergartenSchedule/1.0 (contact@example.com)' }
                });
                const data = await response.json();
                if (data && data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                }
            } catch (err) {
                console.error("×©×’×™××” ×‘× ×•××™× ×˜×™×:", err);
            }
            return null;
        }

        // ×—×™×©×•×‘ ××¨×—×§ + ×–××Ÿ + ×”×“×¨×š ×”××¨×•×›×” ×¢× OSRM
        async function getLongestRouteKmAndTime(from, to) {
            if (!from || !to) return { km: '0.0', timeMin: 0 };

            try {
                const url = `https://router.project-osrm.org/route/v1/driving/${from.lng},${from.lat};${to.lng},${to.lat}?overview=false&alternatives=true`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    // ××™×•×Ÿ ×œ×¤×™ ××¨×—×§ ×™×•×¨×“ â€“ ×œ×§×—×ª ××ª ×”××¨×•×š ×‘×™×•×ª×¨
                    const sorted = data.routes.sort((a, b) => b.distance - a.distance);
                    const longest = sorted[0];

                    return {
                        km: (longest.distance / 1000).toFixed(1),
                        timeMin: Math.round(longest.duration / 60)
                    };
                }
            } catch (err) {
                console.error("×©×’×™××” ×‘-OSRM:", err);
            }
            return { km: '0.0', timeMin: 0 };
        }

        // ×¡×™×›×•× ×§"× ×œ×™×•×
        async function calculateDailyKm() {
            const dayOfWeek = currentDate.getDay();
            if (dayOfWeek === 6) return { km: '0.0', time: 0 };

            const dayLessons = SCHEDULE.filter(l => l.day === dayOfWeek);
            let totalKm = 0;
            let totalTime = 0;

            for (const lesson of dayLessons) {
                const status = getLessonStatus(currentDate, lesson.name);
                if (status !== 'done' && status !== 'double') continue;

                const count = status === 'double' ? 2 : 1;

                const to = await geocodeAddress(lesson.address);
                if (to) {
                    const route = await getLongestRouteKmAndTime(currentLocation, to);
                    totalKm += count * parseFloat(route.km);
                    totalTime += count * route.timeMin;
                } else {
                    // ×× ×œ× ×”×¦×œ×™×— â€“ ××©×ª××© ×‘×¢×¨×š ××©×•×¢×¨
                    totalKm += count * 5;
                    totalTime += count * 15;
                }
            }

            return { km: totalKm.toFixed(1), time: totalTime };
        }

        function renderDaily() {
            const container = document.getElementById('dailyLessons');
            const dayOfWeek = currentDate.getDay();
            
            if (dayOfWeek === 6) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‰</div>
                        <div>×©×‘×ª ×©×œ×•×! ××™×Ÿ ×©×™×¢×•×¨×™× ×”×™×•×</div>
                    </div>
                `;
                document.getElementById('dailyKmSummary').innerHTML = '';
                return;
            }
            
            const dayLessons = SCHEDULE.filter(l => l.day === dayOfWeek);
            
            if (dayLessons.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“…</div>
                        <div>××™×Ÿ ×©×™×¢×•×¨×™× ×§×‘×•×¢×™× ×‘×™×•× ×–×”</div>
                    </div>
                `;
                document.getElementById('dailyKmSummary').innerHTML = '';
                return;
            }
            
            container.innerHTML = dayLessons.map(lesson => {
                const status = getLessonStatus(currentDate, lesson.name);
                const statusClass = status === 'done' ? 'done' : 
                                  status === 'cancelled' ? 'cancelled' : 
                                  status === 'double' ? 'double done' : '';
                
                return `
                    <div class="lesson-card ${statusClass}">
                        <div class="lesson-header">
                            <div class="lesson-time">${lesson.time}</div>
                        </div>
                        <div class="lesson-name">${lesson.name}</div>
                        <div class="lesson-details">
                            ğŸ“ ${lesson.address}<br>
                            ğŸ« ${lesson.type} â€¢ ${lesson.city}
                        </div>
                        <div class="lesson-actions">
                            <button class="action-btn btn-done ${status === 'done' ? 'active' : ''}" 
                                    onclick="setLessonStatus(currentDate, '${lesson.name.replace(/'/g, "\\'")}', '${status === 'done' ? 'pending' : 'done'}')">
                                âœ“ ×‘×•×¦×¢
                            </button>
                            <button class="action-btn btn-double ${status === 'double' ? 'active' : ''}" 
                                    onclick="setLessonStatus(currentDate, '${lesson.name.replace(/'/g, "\\'")}', '${status === 'double' ? 'pending' : 'double'}')">
                                Ã—2 ×›×¤×•×œ
                            </button>
                            <button class="action-btn btn-cancel ${status === 'cancelled' ? 'active' : ''}" 
                                    onclick="setLessonStatus(currentDate, '${lesson.name.replace(/'/g, "\\'")}', '${status === 'cancelled' ? 'pending' : 'cancelled'}')">
                                âœ— ×‘×•×˜×œ
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // ×¡×™×›×•× ×§"× ×œ×™×•×
            calculateDailyKm().then(summary => {
                document.getElementById('dailyKmSummary').innerHTML = `
                    ×¡×”"×› ×§"× ×œ×™×•× ×–×” (×¨×§ ×©×‘×•×¦×¢×•/×›×¤×•×œ×™×): ${summary.km} ×§"× â€¢ ×–××Ÿ ××©×•×¢×¨: ${summary.time} ×“×§×•×ª
                `;
            });
        }

        function showAddMakeup() {
            const lessonName = prompt('×”×›× ×¡ ×©× ×’×Ÿ ×œ×”×©×œ××”:');
            if (!lessonName) return;
            
            const originalLesson = SCHEDULE.find(l => l.name.includes(lessonName) || lessonName.includes(l.name));
            if (!originalLesson) {
                alert('×œ× × ××¦× ×’×Ÿ ×¢× ×”×©× ×”×–×”');
                return;
            }
            
            const nextFriday = new Date(currentDate);
            while (nextFriday.getDay() !== 5) {
                nextFriday.setDate(nextFriday.getDate() + 1);
            }
            
            const dateKey = nextFriday.toISOString().split('T')[0];
            if (!makeupLessons[dateKey]) {
                makeupLessons[dateKey] = [];
            }
            
            const time = prompt('×©×¢×ª ×”×”×©×œ××”:', '09:00');
            if (!time) return;
            
            makeupLessons[dateKey].push({
                ...originalLesson,
                time: time,
                originalLesson: originalLesson.name
            });
            
            db.ref(`makeupLessons/${dateKey}`).set(makeupLessons[dateKey]);
            
            renderAll();
            alert('×©×™×¢×•×¨ ×”×©×œ××” × ×•×¡×£ ×‘×”×¦×œ×—×”!');
        }

        function renderMakeup() {
            const container = document.getElementById('makeupLessons');
            
            const fridays = Object.keys(makeupLessons).sort();
            
            if (fridays.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div>××™×Ÿ ×©×™×¢×•×¨×™ ×”×©×œ××” ××ª×•×›× × ×™×</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = fridays.map(dateKey => {
                const date = new Date(dateKey + 'T00:00:00');
                const lessons = makeupLessons[dateKey];
                
                return `
                    <div class="section-title">
                        ×™×•× ×©×™×©×™, ${date.toLocaleDateString('he-IL', { day: 'numeric', month: 'long' })}
                    </div>
                    ${lessons.map((lesson, index) => {
                        const status = getLessonStatus(date, lesson.name);
                        const statusClass = status === 'done' ? 'done makeup' : 
                                          status === 'cancelled' ? 'cancelled makeup' : 
                                          status === 'double' ? 'double done makeup' : 'makeup';
                        
                        return `
                            <div class="lesson-card ${statusClass}">
                                <div class="lesson-header">
                                    <div class="lesson-time">${lesson.time}</div>
                                </div>
                                <div class="lesson-name">${lesson.name} ğŸ”„</div>
                                <div class="lesson-details">
                                    ğŸ“ ${lesson.address}<br>
                                    ğŸ« ${lesson.type} â€¢ ${lesson.city}<br>
                                    <small>×”×©×œ××” ×¢×‘×•×¨: ${lesson.originalLesson}</small>
                                </div>
                                <div class="lesson-actions">
                                    <button class="action-btn btn-done ${status === 'done' ? 'active' : ''}" 
                                            onclick="setLessonStatus(date, '${lesson.name.replace(/'/g, "\\'")}', '${status === 'done' ? 'pending' : 'done'}')">
                                        âœ“ ×‘×•×¦×¢
                                    </button>
                                    <button class="action-btn btn-double ${status === 'double' ? 'active' : ''}" 
                                            onclick="setLessonStatus(date, '${lesson.name.replace(/'/g, "\\'")}', '${status === 'double' ? 'pending' : 'double'}')">
                                        Ã—2 ×›×¤×•×œ
                                    </button>
                                    <button class="action-btn btn-cancel ${status === 'cancelled' ? 'active' : ''}" 
                                            onclick="setLessonStatus(date, '${lesson.name.replace(/'/g, "\\'")}', '${status === 'cancelled' ? 'pending' : 'cancelled'}')">
                                        âœ— ×‘×•×˜×œ
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            }).join('');
        }

        function calculateStats(startDate, endDate) {
            let total = 0, ramla = 0, by = 0;
            let sportigenR = 0, sportigenB = 0, theaterR = 0, theaterB = 0;
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dayOfWeek = d.getDay();
                if (dayOfWeek === 6) continue;
                
                const dayLessons = SCHEDULE.filter(l => l.day === dayOfWeek);
                
                dayLessons.forEach(lesson => {
                    const status = getLessonStatus(d, lesson.name);
                    if (status === 'cancelled') return;
                    
                    const count = status === 'double' ? 2 : 1;
                    total += count;
                    
                    if (lesson.city === '×¨××œ×”') {
                        ramla += count;
                        if (lesson.type === '×¡×¤×•×¨×˜×™×’×Ÿ') sportigenR += count;
                        else theaterR += count;
                    } else {
                        by += count;
                        if (lesson.type === '×¡×¤×•×¨×˜×™×’×Ÿ') sportigenB += count;
                        else theaterB += count;
                    }
                });
                
                const dateKey = d.toISOString().split('T')[0];
                if (makeupLessons[dateKey]) {
                    makeupLessons[dateKey].forEach(lesson => {
                        const status = getLessonStatus(d, lesson.name);
                        if (status === 'cancelled') return;
                        
                        const count = status === 'double' ? 2 : 1;
                        total += count;
                        
                        if (lesson.city === '×¨××œ×”') {
                            ramla += count;
                            if (lesson.type === '×¡×¤×•×¨×˜×™×’×Ÿ') sportigenR += count;
                            else theaterR += count;
                        } else {
                            by += count;
                            if (lesson.type === '×¡×¤×•×¨×˜×™×’×Ÿ') sportigenB += count;
                            else theaterB += count;
                        }
                    });
                }
            }
            
            return { total, ramla, by, sportigenR, sportigenB, theaterR, theaterB };
        }

        function renderWeekly() {
            const container = document.getElementById('weeklyContent');
            
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay());
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const stats = calculateStats(weekStart, weekEnd);
            
            container.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #667eea; text-align: center;">
                    ×¡×™×›×•× ×©×‘×•×¢×™<br>
                    <small style="font-size: 0.8em; font-weight: normal;">
                        ${weekStart.toLocaleDateString('he-IL', { day: 'numeric', month: 'long' })} - 
                        ${weekEnd.toLocaleDateString('he-IL', { day: 'numeric', month: 'long' })}
                    </small>
                </h3>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">×¡×”"×› ×©×™×¢×•×¨×™×</div>
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-subvalue">×—×™×©×•×‘ 1.3: ${(stats.total * 1.3).toFixed(1)}</div>
                    </div>
                    <div class="stat-card ramla">
                        <div class="stat-label">×‘×¨××œ×”</div>
                        <div class="stat-value">${stats.ramla}</div>
                        <div class="stat-subvalue">×¡×¤×•×¨×˜×™×’×Ÿ: ${stats.sportigenR} | ×¤×œ××™: ${stats.theaterR}</div>
                    </div>
                    <div class="stat-card by">
                        <div class="stat-label">×‘×‘××¨ ×™×¢×§×‘</div>
                        <div class="stat-value">${stats.by}</div>
                        <div class="stat-subvalue">×¡×¤×•×¨×˜×™×’×Ÿ: ${stats.sportigenB} | ×¤×œ××™: ${stats.theaterB}</div>
                    </div>
                </div>
                
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>×¢×™×¨</th>
                            <th>×¡×¤×•×¨×˜×™×’×Ÿ</th>
                            <th>×¤×œ××™ ×ª××˜×¨×•×Ÿ</th>
                            <th>×¡×”"×›</th>
                            <th>×—×™×©×•×‘ 1.3</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>×¨××œ×”</td>
                            <td>${stats.sportigenR}</td>
                            <td>${stats.theaterR}</td>
                            <td>${stats.ramla}</td>
                            <td>${(stats.ramla * 1.3).toFixed(1)}</td>
                        </tr>
                        <tr>
                            <td>×‘××¨ ×™×¢×§×‘</td>
                            <td>${stats.sportigenB}</td>
                            <td>${stats.theaterB}</td>
                            <td>${stats.by}</td>
                            <td>${(stats.by * 1.3).toFixed(1)}</td>
                        </tr>
                        <tr class="total-row">
                            <td>×¡×”"×›</td>
                            <td>${stats.sportigenR + stats.sportigenB}</td>
                            <td>${stats.theaterR + stats.theaterB}</td>
                            <td>${stats.total}</td>
                            <td>${(stats.total * 1.3).toFixed(1)}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        function renderMonthly() {
            const container = document.getElementById('monthlyContent');
            
            const monthStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const monthEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            const stats = calculateStats(monthStart, monthEnd);
            
            const monthName = currentDate.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' });
            
            container.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #667eea; text-align: center;">
                    ×“×•×— ×—×•×“×©×™ - ${monthName}
                </h3>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">×¡×”"×› ×©×™×¢×•×¨×™×</div>
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-subvalue">×—×™×©×•×‘ 1.3: ${(stats.total * 1.3).toFixed(1)}</div>
                    </div>
                    <div class="stat-card ramla">
                        <div class="stat-label">×‘×¨××œ×”</div>
                        <div class="stat-value">${stats.ramla}</div>
                        <div class="stat-subvalue">×¡×¤×•×¨×˜×™×’×Ÿ: ${stats.sportigenR} | ×¤×œ××™: ${stats.theaterR}</div>
                    </div>
                    <div class="stat-card by">
                        <div class="stat-label">×‘×‘××¨ ×™×¢×§×‘</div>
                        <div class="stat-value">${stats.by}</div>
                        <div class="stat-subvalue">×¡×¤×•×¨×˜×™×’×Ÿ: ${stats.sportigenB} | ×¤×œ××™: ${stats.theaterB}</div>
                    </div>
                </div>
                
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>×§×˜×’×•×¨×™×”</th>
                            <th>×¨××œ×”</th>
                            <th>×‘××¨ ×™×¢×§×‘</th>
                            <th>×¡×”"×›</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>×¡×¤×•×¨×˜×™×’×Ÿ</td>
                            <td>${stats.sportigenR}</td>
                            <td>${stats.sportigenB}</td>
                            <td>${stats.sportigenR + stats.sportigenB}</td>
                        </tr>
                        <tr>
                            <td>×¤×œ××™ ×ª××˜×¨×•×Ÿ</td>
                            <td>${stats.theaterR}</td>
                            <td>${stats.theaterB}</td>
                            <td>${stats.theaterR + stats.theaterB}</td>
                        </tr>
                        <tr class="total-row">
                            <td>×¡×”"×›</td>
                            <td>${stats.ramla}</td>
                            <td>${stats.by}</td>
                            <td>${stats.total}</td>
                        </tr>
                        <tr>
                            <td>×—×™×©×•×‘ 1.3</td>
                            <td>${(stats.ramla * 1.3).toFixed(1)}</td>
                            <td>${(stats.by * 1.3).toFixed(1)}</td>
                            <td>${(stats.total * 1.3).toFixed(1)}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        function exportReport(type) {
            let startDate, endDate, title;
           
            if (type === 'weekly') {
                startDate = new Date(currentDate);
                startDate.setDate(currentDate.getDate() - currentDate.getDay());
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                title = `×“×•×—_×©×‘×•×¢×™_${startDate.toISOString().split('T')[0]}`;
            } else {
                startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                const monthName = currentDate.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' });
                title = `×“×•×—_×—×•×“×©×™_${monthName.replace(' ', '_')}`;
            }
           
            const stats = calculateStats(startDate, endDate);
           
            let csv = `${title}\n\n`;
            csv += '×§×˜×’×•×¨×™×”,×¨××œ×”,×‘××¨ ×™×¢×§×‘,×¡×”"×›\n';
            csv += `×¡×¤×•×¨×˜×™×’×Ÿ,${stats.sportigenR},${stats.sportigenB},${stats.sportigenR + stats.sportigenB}\n`;
            csv += `×¤×œ××™ ×ª××˜×¨×•×Ÿ,${stats.theaterR},${stats.theaterB},${stats.theaterR + stats.theaterB}\n`;
            csv += `×¡×”"×›,${stats.ramla},${stats.by},${stats.total}\n`;
            csv += `×—×™×©×•×‘ 1.3,${(stats.ramla * 1.3).toFixed(1)},${(stats.by * 1.3).toFixed(1)},${(stats.total * 1.3).toFixed(1)}\n`;
           
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${title}.csv`;
            link.click();
        }

        function renderAll() {
            const activeTab = document.querySelector('.tab.active');
            if (!activeTab) return;
           
            const tabText = activeTab.textContent.trim();
           
            if (tabText.includes('×™×•××™')) renderDaily();
            else if (tabText.includes('×”×©×œ××•×ª')) renderMakeup();
            else if (tabText.includes('×©×‘×•×¢×™')) renderWeekly();
            else if (tabText.includes('×—×•×“×©×™')) renderMonthly();
        }

        // Initialize
        loadData();
        updateDateDisplay();
        renderAll();
    </script>
</body>
</html>
